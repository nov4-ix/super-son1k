<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Son1kVers3 ‚Äî La Resistencia</title>
  
  <!-- SEO / Share / PWA -->
  <meta name="description" content="Son1kVers3: Genera m√∫sica, Ghost Studio y Archivo central. Lo imperfecto tambi√©n es sagrado.">
  <meta property="og:title" content="Son1kVers3 ‚Äî Resistencia sonora">
  <meta property="og:description" content="Texto‚ÜíM√∫sica, Ghost Studio, Archivo.">
  <meta name="theme-color" content="#0b0b0d">
  
  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- üéØ SOLUCI√ìN GARANTIZADA: Transparencia Total -->
  <script>
/**
 * üéØ SOLUCI√ìN GARANTIZADA: Transparencia Total del Frontend
 * Este script se ejecuta inmediatamente y asegura transparencia completa
 */
(function() {
    'use strict';
    
    console.log('üéØ INICIANDO SOLUCI√ìN DE TRANSPARENCIA GARANTIZADA');
    
    // 1. INTERCEPTAR Y CORREGIR TODAS LAS RESPUESTAS
    const originalFetch = window.fetch;
    window.fetch = async function(url, options) {
        console.log('üîç Interceptando fetch:', url);
        
        // Hacer la request original
        const response = await originalFetch(url, options);
        
        // Si es request de m√∫sica, interceptar y corregir la respuesta
        if (url.includes('/api/music/') || url.includes('generate')) {
            console.log('üéµ Interceptando respuesta de m√∫sica');
            
            const originalJson = response.json;
            response.json = async function() {
                const data = await originalJson.call(this);
                console.log('üì• Respuesta original:', data);
                
                // CORREGIR RESPUESTA PARA SER TRANSPARENTE
                const correctedData = makeResponseTransparent(data);
                console.log('‚úÖ Respuesta corregida:', correctedData);
                
                return correctedData;
            };
        }
        
        return response;
    };
    
    // 2. FUNCI√ìN PARA HACER RESPUESTA TRANSPARENTE
    function makeResponseTransparent(data) {
        if (!data) return data;
        
        // Crear copia para no modificar original
        const transparent = JSON.parse(JSON.stringify(data));
        
        // CORREGIR JOB ID
        if (transparent.job_id) {
            transparent.job_id = transparent.job_id.replace(/suno/gi, 'son1k');
            console.log('üîß Job ID corregido:', transparent.job_id);
        }
        
        // CORREGIR TRACKS
        if (transparent.tracks && Array.isArray(transparent.tracks)) {
            transparent.tracks = transparent.tracks.map((track, index) => {
                const correctedTrack = { ...track };
                
                // Generar nombre din√°mico basado en lyrics
                if (track.lyrics_preview || data.lyrics) {
                    const lyrics = track.lyrics_preview || data.lyrics || '';
                    correctedTrack.title = generateDynamicName(lyrics, index);
                    correctedTrack.filename = `${correctedTrack.title.replace(/[^a-zA-Z0-9]/g, '_')}.mp3`;
                }
                
                // Asegurar provider transparente
                correctedTrack.provider = 'Son1k';
                
                // Corregir cualquier referencia a suno
                if (correctedTrack.job_id) {
                    correctedTrack.job_id = correctedTrack.job_id.replace(/suno/gi, 'son1k');
                }
                
                console.log(`‚ú® Track ${index + 1} corregido:`, correctedTrack.title);
                return correctedTrack;
            });
        }
        
        // LIMPIAR CUALQUIER REFERENCIA A SUNO EN TODO EL OBJETO
        cleanSunoReferences(transparent);
        
        return transparent;
    }
    
    // 3. GENERAR NOMBRE DIN√ÅMICO DESDE LYRICS
    function generateDynamicName(lyrics, index = 0) {
        if (!lyrics || !lyrics.trim()) {
            return `Instrumental_${Date.now()}`;
        }
        
        // Tomar primera l√≠nea significativa
        const lines = lyrics.split('\n');
        let firstLine = '';
        
        for (const line of lines) {
            const cleaned = line.trim();
            if (cleaned.length > 3 && !cleaned.match(/^[^\w]*$/) && !cleaned.toLowerCase().includes('suno')) {
                firstLine = cleaned;
                break;
            }
        }
        
        if (!firstLine) {
            // Usar primeras palabras (excluyendo 'suno')
            const words = lyrics.trim().split(/\s+/)
                .filter(word => !word.toLowerCase().includes('suno'))
                .slice(0, 4);
            firstLine = words.join(' ') || 'Sin T√≠tulo';
        }
        
        // Limpiar y capitalizar
        let cleanName = firstLine
            .replace(/[<>:"/\\|?*]/g, '')
            .replace(/\s+/g, ' ')
            .trim();
        
        // Capitalizar cada palabra
        cleanName = cleanName.split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
        
        // Limitar longitud
        if (cleanName.length > 50) {
            cleanName = cleanName.substring(0, 47) + '...';
        }
        
        // Agregar variaci√≥n si hay m√∫ltiples tracks
        if (index > 0) {
            cleanName += ` - Parte ${index + 1}`;
        }
        
        // Limpieza final: eliminar cualquier referencia a suno
        cleanName = cleanName.replace(/suno/gi, 'Son1k');
        
        return cleanName || `Composici√≥n_${Date.now()}`;
    }
    
    // 4. LIMPIAR REFERENCIAS A SUNO EN TODO EL OBJETO
    function cleanSunoReferences(obj) {
        if (typeof obj === 'object' && obj !== null) {
            for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'string') {
                    obj[key] = value.replace(/suno/gi, 'son1k');
                } else if (typeof value === 'object') {
                    cleanSunoReferences(value);
                }
            }
        }
    }
    
    // 5. VERIFICAR QUE TODO FUNCIONA
    function verifyTransparency() {
        console.log('üß™ Verificando transparencia...');
        
        const testData = {
            job_id: 'suno_job_12345',
            tracks: [{
                title: 'suno_track_1',
                job_id: 'suno_job_12345',
                provider: 'Suno',
                lyrics_preview: 'Walking down the street tonight'
            }]
        };
        
        const corrected = makeResponseTransparent(testData);
        
        console.log('üìä Test de transparencia:');
        console.log('  Job ID:', corrected.job_id);
        console.log('  Track title:', corrected.tracks[0].title);
        console.log('  Provider:', corrected.tracks[0].provider);
        
        const isTransparent = 
            !corrected.job_id.includes('suno') &&
            !corrected.tracks[0].title.includes('suno') &&
            corrected.tracks[0].provider === 'Son1k';
        
        console.log(isTransparent ? '‚úÖ TRANSPARENCIA VERIFICADA' : '‚ùå TRANSPARENCIA FALLIDA');
        return isTransparent;
    }
    
    // Ejecutar verificaci√≥n
    setTimeout(verifyTransparency, 1000);
    
    console.log('üéØ SOLUCI√ìN DE TRANSPARENCIA GARANTIZADA INSTALADA');
    
})();
  </script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { 
            neon: '#00FFE7', 
            coal: '#0B0B0F', 
            haze: '#0f111a',
            'neon-purple': '#8b5cf6',
            'neon-blue': '#06b6d4' 
          },
          boxShadow: { glow: '0 0 40px rgba(0,255,231,.25)' }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    html { background: #0f111a !important; }
    body { background: #0f111a !important; color: #e4e4e7 !important; font-family: Inter, ui-sans-serif, system-ui !important; }
    
    .glitch { position: relative; }
    .glitch::before, .glitch::after { content: attr(data-text); position: absolute; inset: 0; pointer-events: none; }
    .glitch::before { left: 2px; text-shadow: -2px 0 #f0f; clip-path: inset(10% 0 30% 0); }
    .glitch::after { left: -2px; text-shadow: -2px 0 #0ff; clip-path: inset(60% 0 5% 0); }
    
    .knob { 
      width: 80px; height: 80px; border-radius: 50%; position: relative; 
      background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
      cursor: pointer; transition: all 0.2s ease;
      border: 3px solid #333;
      margin: 0 auto;
      user-select: none;
    }
    .knob:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,231,.3); }
    .knob:focus-visible { 
      outline: 2px solid #00FFE7; 
      outline-offset: 2px; 
    }
    .knob::after { 
      content: ''; position: absolute; left: 50%; top: 10px; 
      width: 4px; height: 20px; background: #00FFE7; border-radius: 2px; 
      transform: translateX(-50%) rotate(var(--rotation, 0deg)); 
      box-shadow: 0 0 8px rgba(0,255,231,.8); 
      transition: transform 0.1s ease;
    }
    
    .knob-small { 
      width: 60px; height: 60px; 
    }
    .knob-small::after { 
      top: 8px; 
      width: 3px; height: 16px; 
    }
    
    .slider-container {
      position: relative;
      margin: 20px 0;
    }
    
    .custom-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: linear-gradient(90deg, #333 0%, #00FFE7 var(--value, 50%), #333 var(--value, 50%));
      outline: none;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    
    .custom-slider:hover {
      opacity: 1;
    }
    
    .custom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00FFE7;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0,255,231,.5);
    }
    
    .custom-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #00FFE7;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 10px rgba(0,255,231,.5);
    }
    
    .text-neon { color: #00FFE7 !important; }
    .bg-neon { background-color: #00FFE7 !important; }
    .border-neon { border-color: #00FFE7 !important; }
    .shadow-glow { box-shadow: 0 0 40px rgba(0,255,231,.25) !important; }
    .bg-haze { background-color: #0f111a !important; }
    
    .tab-active { 
      background: linear-gradient(45deg, #00FFE7, #8b5cf6);
      color: #000;
    }
    
    .section-hidden { display: none; }
    
    @keyframes pulse-neon {
      0%, 100% { box-shadow: 0 0 5px rgba(0,255,231,.5); }
      50% { box-shadow: 0 0 20px rgba(0,255,231,.8); }
    }
    
    .pulse-neon { animation: pulse-neon 2s infinite; }
    
    /* Botones con focus visible */
    .btn:focus-visible {
      outline: 2px solid #00FFE7;
      outline-offset: 2px;
    }
    
    /* Status indicators */
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }
    .status-online { background-color: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.5); }
    .status-offline { background-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
    .status-pending { background-color: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.5); }

    /* Optimizaci√≥n m√≥vil - reducir blur en pantallas peque√±as */
    @media (max-width: 768px) {
      .blur-3xl { filter: blur(16px); }
      .backdrop-blur-xl { backdrop-filter: blur(8px); }
    }
    
    /* Respeto a preferencias de movimiento reducido */
    @media (prefers-reduced-motion: reduce) {
      .pulse-neon { animation: none; }
      .transition { transition: none; }
      .knob::after { transition: none; }
    }
  </style>
</head>

<body class="antialiased overflow-x-hidden bg-haze">
  <!-- Audio player global para reproducci√≥n (sr-only para producci√≥n, quita esta clase para debug) -->
  <audio id="player" class="sr-only" aria-hidden="true"></audio>
  
  <!-- Contenedor de toasts accesible -->
  <div id="toast-area" class="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- NAVEGACI√ìN -->
  <nav class="fixed top-0 left-0 right-0 z-50 bg-zinc-950/80 backdrop-blur-xl border-b border-white/10" role="navigation">
    <div class="mx-auto max-w-7xl px-4 flex items-center justify-between h-16">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-neon to-neon-purple flex items-center justify-center">
          <span class="text-xs font-bold text-black">S3</span>
        </div>
        <span class="text-xl font-bold text-neon">SON1KVERS3</span>
      </div>
      
      <div class="flex space-x-6" role="tablist">
        <button class="nav-tab tab-active px-4 py-2 rounded-lg transition btn" 
                data-section="home" 
                role="tab" 
                aria-selected="true">Historia</button>
        <button class="nav-tab px-4 py-2 rounded-lg transition btn" 
                data-section="ghost-studio" 
                role="tab" 
                aria-selected="false">Ghost Studio</button>
        <button class="nav-tab px-4 py-2 rounded-lg transition btn" 
                data-section="generacion" 
                role="tab" 
                aria-selected="false">Generaci√≥n</button>
        <button class="nav-tab px-4 py-2 rounded-lg transition btn" 
                data-section="resultados" 
                role="tab" 
                aria-selected="false">Reproductor</button>
        <button class="nav-tab px-4 py-2 rounded-lg transition btn" 
                data-section="extension" 
                role="tab" 
                aria-selected="false">Extensi√≥n</button>
        <button class="nav-tab px-4 py-2 rounded-lg transition btn" 
                data-section="archivo" 
                role="tab" 
                aria-selected="false">Archivo</button>
      </div>
      
      <!-- Botones de autenticaci√≥n -->
      <div id="authButtons" class="flex space-x-3">
        <button onclick="showLoginModal()" class="border border-white/20 px-4 py-2 rounded-lg hover:bg-white/5 transition btn">
          Login
        </button>
        <button onclick="showRegisterModal()" class="bg-neon text-black px-4 py-2 rounded-lg font-semibold hover:bg-neon/90 transition btn">
          Registro
        </button>
      </div>
      
      <!-- Informaci√≥n del usuario autenticado -->
      <div id="userInfo" style="display: none;"></div>
      
      <!-- Bot√≥n "Entrar al Estudio" (redirigir√° o pedir√° auth) -->
      <button id="entrarEstudio" class="bg-neon text-black px-6 py-2 rounded-lg font-semibold hover:bg-neon/90 transition btn">
        Entrar al Estudio
      </button>
    </div>
  </nav>

  <!-- SECCI√ìN HOME -->
  <section id="home" class="content-section min-h-screen pt-20 pb-10" aria-hidden="false">
    <div class="mx-auto max-w-7xl px-4 grid lg:grid-cols-2 gap-12 items-center min-h-[80vh]">
      <div class="space-y-8">
        <div class="space-y-2">
          <p class="text-sm font-medium text-zinc-400 tracking-widest uppercase">LA RESISTENCIA</p>
          <h1 class="text-4xl md:text-6xl font-bold leading-tight">
            Lo imperfecto tambi√©n<br>
            <span class="text-neon">es sagrado</span>
          </h1>
          <h2 class="text-2xl md:text-3xl text-zinc-300 mt-4">
            Componer con alma<br>
            en un mundo de<br>
            <span class="text-neon-purple">m√°quinas.</span>
          </h2>
        </div>
        
        <div class="flex space-x-4">
          <button id="entrarEstudioMain" class="bg-neon text-black px-8 py-3 rounded-lg font-semibold hover:bg-neon/90 transition shadow-glow btn">
            Entrar al Estudio
          </button>
          <button id="conocerUniverso" class="border border-white/20 px-8 py-3 rounded-lg hover:bg-white/5 transition btn">
            Conocer el Universo
          </button>
        </div>
        
        <p class="text-zinc-400 max-w-lg">
          Genera m√∫sica, clona voces cantadas, mezcla con calidad de estudio y guarda tu proceso en un archivo vivo. Bienvenido al Estudio Fantasma.
        </p>

        <!-- Sistema de Status -->
        <div class="bg-zinc-900/30 rounded-xl border border-white/10 p-6">
          <h3 class="text-lg font-semibold mb-4">Estado del Sistema</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex items-center">
              <span id="api-status" class="status-indicator status-online"></span>
              <span>API Backend</span>
            </div>
            <div class="flex items-center">
              <span id="celery-status" class="status-indicator status-offline"></span>
              <span>Celery Worker</span>
            </div>
            <div class="flex items-center">
              <span id="redis-status" class="status-indicator status-offline"></span>
              <span>Redis</span>
            </div>
            <div class="flex items-center">
              <span id="extension-status" class="status-indicator status-offline"></span>
              <span>Chrome Extension</span>
            </div>
          </div>
          <button class="mt-4 text-neon text-sm hover:underline btn" onclick="refreshSystemStatus()">üîÑ Refresh Status</button>
        </div>
      </div>
      
      <div class="relative">
        <div class="absolute -inset-10 -z-10 blur-3xl opacity-30" style="background: conic-gradient(from 45deg, rgba(0,255,231,.2), transparent, rgba(99,102,241,.2))"></div>
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8 shadow-2xl">
          <div class="text-center mb-6">
            <h3 class="text-xl font-semibold mb-2">Controles de Expresividad</h3>
            <p class="text-sm text-zinc-400">Ajusta los par√°metros para crear tu sonido √∫nico</p>
          </div>
          
          <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="text-center">
              <div class="knob" 
                   data-knob="expresividad" 
                   data-value="75"
                   role="slider"
                   tabindex="0"
                   aria-valuemin="0"
                   aria-valuemax="100"
                   aria-valuenow="75"
                   aria-label="Expresividad"></div>
              <p class="text-sm mt-2 text-zinc-400">Expresividad</p>
              <p class="text-xs text-neon font-mono" id="expresividadDisplay">75%</p>
            </div>
            <div class="text-center">
              <div class="knob" 
                   data-knob="creatividad" 
                   data-value="60"
                   role="slider"
                   tabindex="0"
                   aria-valuemin="0"
                   aria-valuemax="100"
                   aria-valuenow="60"
                   aria-label="Creatividad"></div>
              <p class="text-sm mt-2 text-zinc-400">Creatividad</p>
              <p class="text-xs text-neon font-mono" id="creatividadDisplay">60%</p>
            </div>
            <div class="text-center">
              <div class="knob" 
                   data-knob="precision" 
                   data-value="85"
                   role="slider"
                   tabindex="0"
                   aria-valuemin="0"
                   aria-valuemax="100"
                   aria-valuenow="85"
                   aria-label="Precisi√≥n"></div>
              <p class="text-sm mt-2 text-zinc-400">Precisi√≥n</p>
              <p class="text-xs text-neon font-mono" id="precisionDisplay">85%</p>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <button id="testRapido" class="rounded-lg border border-neon/30 text-neon px-4 py-3 hover:bg-neon/10 transition font-medium btn">
              Test R√°pido
            </button>
            <button id="generarPreview" class="rounded-lg bg-neon/10 border border-neon text-neon px-4 py-3 hover:bg-neon/20 transition font-medium btn">
              Generar Preview
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN GENERACI√ìN -->
  <section id="generacion" class="content-section section-hidden min-h-screen pt-20 pb-10" aria-hidden="true">
    <div class="mx-auto max-w-7xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Generaci√≥n Musical</h2>
        <p class="text-zinc-400 max-w-2xl mx-auto">Beats, letras, voces cantadas clonadas y mezcla con calidad de estudio. Todo en un flujo.</p>
        <div class="flex justify-center space-x-4 mt-6">
          <button class="bg-neon/10 text-neon px-4 py-2 rounded-lg border border-neon btn">API</button>
          <button class="bg-white/5 text-white px-4 py-2 rounded-lg border border-white/20 btn">Docs</button>
        </div>
      </div>
      
      <!-- Generaci√≥n Musical Simple -->
      <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
        <h3 class="text-2xl font-semibold mb-6 text-center">Generaci√≥n Musical Simple</h3>
        <div class="grid lg:grid-cols-2 gap-8">
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-zinc-300 mb-2">Letra de la canci√≥n</label>
              <textarea 
                class="w-full h-32 bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white resize-none"
                placeholder="Escribe aqu√≠ la letra de tu canci√≥n..."
                id="letraCancion"
              ></textarea>
              <div class="flex space-x-2 mt-2">
                <button id="generarLetraIA" class="text-xs bg-neon-purple/20 text-neon-purple px-3 py-2 rounded-lg hover:bg-neon-purple/30 transition btn">
                  ü§ñ Generar Letra con IA
                </button>
                <button id="mejorarLetra" class="text-xs bg-neon-blue/20 text-neon-blue px-3 py-2 rounded-lg hover:bg-neon-blue/30 transition btn">
                  ‚ú® Mejorar Letra
                </button>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-zinc-300 mb-2">Prompt de estilo musical</label>
              <input 
                type="text" 
                class="w-full bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white"
                placeholder="Ej: una balada emotiva con piano y cuerdas, estilo neo-soul, tempo 70 BPM"
                id="promptEstilo"
              >
              <div class="flex space-x-2 mt-2">
                <button id="promptInteligente" class="text-xs bg-neon/20 text-neon px-3 py-2 rounded-lg hover:bg-neon/30 transition btn">
                  üéØ Prompt Inteligente
                </button>
                <button id="analizarTexto" class="text-xs bg-yellow-500/20 text-yellow-500 px-3 py-2 rounded-lg hover:bg-yellow-500/30 transition btn">
                  üìä Analizar Texto
                </button>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-zinc-300 mb-2">Preset de generaci√≥n</label>
              <select class="w-full bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white" id="presetGeneracion">
                <option>Profesional</option>
                <option>Experimental</option>
                <option>Vintage</option>
                <option>Moderno</option>
                <option>Cinematogr√°fico</option>
              </select>
            </div>
            
            <!-- Toggle instrumental a√±adido -->
            <label class="inline-flex items-center gap-2">
              <input id="modoInstrumental" type="checkbox">
              <span class="text-sm text-zinc-300">Generar instrumental (sin voz)</span>
            </label>
          </div>
          
          <div class="space-y-6">
            <div>
              <h4 class="text-lg font-medium mb-4">Controles de Expresividad</h4>
              <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                  <div class="knob knob-small" 
                       data-knob="afinacion" 
                       data-value="60"
                       role="slider"
                       tabindex="0"
                       aria-valuemin="0"
                       aria-valuemax="100"
                       aria-valuenow="60"
                       aria-label="Afinaci√≥n"></div>
                  <p class="text-xs mt-1 text-zinc-400">Afinaci√≥n</p>
                  <p class="text-xs text-neon" id="afinacionDisplay">60%</p>
                </div>
                <div class="text-center">
                  <div class="knob knob-small" 
                       data-knob="expresividad-gen" 
                       data-value="75"
                       role="slider"
                       tabindex="0"
                       aria-valuemin="0"
                       aria-valuemax="100"
                       aria-valuenow="75"
                       aria-label="Expresividad"></div>
                  <p class="text-xs mt-1 text-zinc-400">Expresividad</p>
                  <p class="text-xs text-neon" id="expresividadGenDisplay">75%</p>
                </div>
              </div>
            </div>
            
            <div>
              <h4 class="text-lg font-medium mb-4">Postprocesamiento</h4>
              <div class="space-y-3">
                <div>
                  <label class="text-xs text-zinc-400">EQ (SSL-style)</label>
                  <input type="range" class="custom-slider w-full" value="50" min="0" max="100" id="eq">
                </div>
                <div class="grid grid-cols-4 gap-2">
                  <div class="text-center">
                    <div class="knob knob-small" 
                         data-knob="low" 
                         data-value="50"
                         role="slider"
                         tabindex="0"
                         aria-valuemin="0"
                         aria-valuemax="100"
                         aria-valuenow="50"
                         aria-label="Low"></div>
                    <p class="text-xs text-zinc-400">Low</p>
                  </div>
                  <div class="text-center">
                    <div class="knob knob-small" 
                         data-knob="mid" 
                         data-value="50"
                         role="slider"
                         tabindex="0"
                         aria-valuemin="0"
                         aria-valuemax="100"
                         aria-valuenow="50"
                         aria-label="Mid"></div>
                    <p class="text-xs text-zinc-400">Mid</p>
                  </div>
                  <div class="text-center">
                    <div class="knob knob-small" 
                         data-knob="high" 
                         data-value="50"
                         role="slider"
                         tabindex="0"
                         aria-valuemin="0"
                         aria-valuemax="100"
                         aria-valuenow="50"
                         aria-label="High"></div>
                    <p class="text-xs text-zinc-400">High</p>
                  </div>
                  <div class="text-center">
                    <div class="knob knob-small" 
                         data-knob="air" 
                         data-value="50"
                         role="slider"
                         tabindex="0"
                         aria-valuemin="0"
                         aria-valuemax="100"
                         aria-valuenow="50"
                         aria-label="Air"></div>
                    <p class="text-xs text-zinc-400">Air</p>
                  </div>
                </div>
                <div>
                  <label class="text-xs text-zinc-400">Saturaci√≥n (Rupert-style)</label>
                  <input type="range" class="custom-slider w-full" value="30" min="0" max="100" id="saturacion">
                </div>
              </div>
            </div>
            
            <button id="generarMusica" class="w-full bg-neon text-black rounded-lg py-4 font-semibold text-lg hover:bg-neon/90 transition shadow-glow btn">
              Generar M√∫sica
            </button>
            <p class="text-xs text-zinc-400 text-center mt-2">* Funcionando en modo demo</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN RESULTADOS Y REPRODUCTOR -->
  <section id="resultados" class="content-section min-h-screen pt-20 pb-10" aria-hidden="false">
    <div class="mx-auto max-w-7xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Reproductor y Gesti√≥n de Audio</h2>
        <p class="text-zinc-400 max-w-2xl mx-auto">Reproduce, descarga y gestiona tu m√∫sica generada con IA</p>
      </div>
      
      <!-- Progress Tracking & WebSocket Status -->
      <div id="jobProgress" class="max-w-4xl mx-auto mb-8" style="display: none;">
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Progreso de Generaci√≥n</h3>
            <div class="flex items-center space-x-2">
              <div id="wsStatus" class="w-3 h-3 bg-red-500 rounded-full"></div>
              <span class="text-sm text-zinc-400">WebSocket</span>
            </div>
          </div>
          
          <div class="space-y-4">
            <div>
              <div class="flex justify-between text-sm mb-2">
                <span id="progressMessage">Inicializando...</span>
                <span id="progressPercent">0%</span>
              </div>
              <div class="w-full bg-zinc-700 rounded-full h-3">
                <div id="progressBar" class="bg-neon h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
              </div>
            </div>
            
            <div id="jobDetails" class="text-sm text-zinc-400">
              <p><strong>Job ID:</strong> <span id="currentJobId">-</span></p>
              <p><strong>Estado:</strong> <span id="currentJobStatus">-</span></p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Audio Player Component -->
      <div class="max-w-4xl mx-auto mb-8">
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
          <h3 class="text-xl font-semibold mb-6 text-center">Reproductor de Audio</h3>
          
          <!-- Main Audio Player -->
          <div id="mainPlayer" class="bg-zinc-900/50 rounded-xl p-6 mb-6" style="display: none;">
            <div class="flex items-center space-x-4 mb-4">
              <button id="playPauseBtn" class="w-12 h-12 bg-neon rounded-full flex items-center justify-center text-black hover:bg-neon/90 transition">
                <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
                <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                </svg>
              </button>
              
              <div class="flex-1">
                <div class="flex justify-between text-sm mb-2">
                  <span id="currentTrackName">Sin audio seleccionado</span>
                  <span id="trackDuration">00:00</span>
                </div>
                <div class="relative">
                  <input type="range" id="progressSlider" class="w-full h-2 bg-zinc-700 rounded-lg appearance-none slider" 
                         min="0" max="100" value="0">
                  <div class="flex justify-between text-xs text-zinc-400 mt-1">
                    <span id="currentTime">00:00</span>
                    <span id="totalTime">00:00</span>
                  </div>
                </div>
              </div>
              
              <div class="flex items-center space-x-2">
                <button id="volumeBtn" class="text-zinc-400 hover:text-white transition">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                  </svg>
                </button>
                <input type="range" id="volumeSlider" class="w-20 h-2 bg-zinc-700 rounded-lg appearance-none slider" 
                       min="0" max="100" value="50">
              </div>
            </div>
            
            <!-- Track Metadata -->
            <div id="trackMetadata" class="text-sm text-zinc-400 grid grid-cols-2 gap-4">
              <div>
                <p><strong>Archivo:</strong> <span id="fileName">-</span></p>
                <p><strong>Tama√±o:</strong> <span id="fileSize">-</span></p>
              </div>
              <div>
                <p><strong>Formato:</strong> <span id="fileFormat">-</span></p>
                <p><strong>Generado:</strong> <span id="generatedAt">-</span></p>
              </div>
            </div>
          </div>
          
          <!-- Audio Controls -->
          <div class="flex justify-center space-x-4 mb-6">
            <button id="downloadCurrentBtn" class="bg-neon/20 text-neon px-4 py-2 rounded-lg border border-neon hover:bg-neon/30 transition btn" disabled>
              üì• Descargar
            </button>
            <button id="shareBtn" class="bg-zinc-700 text-white px-4 py-2 rounded-lg hover:bg-zinc-600 transition btn" disabled>
              üîó Compartir
            </button>
            <button id="deleteBtn" class="bg-red-500/20 text-red-400 px-4 py-2 rounded-lg border border-red-500/50 hover:bg-red-500/30 transition btn" disabled>
              üóëÔ∏è Eliminar
            </button>
          </div>
          
          <!-- Audio Library -->
          <div>
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-medium">Biblioteca de Audio</h4>
              <div class="flex space-x-2">
                <button id="refreshLibraryBtn" class="text-neon hover:text-neon/80 transition btn">
                  üîÑ Actualizar
                </button>
                <button id="cleanupBtn" class="text-red-400 hover:text-red-300 transition btn">
                  üßπ Limpiar
                </button>
              </div>
            </div>
            
            <div id="audioLibrary" class="space-y-2 max-h-96 overflow-y-auto">
              <div class="text-center text-zinc-400 py-8">
                <p>No hay archivos de audio disponibles</p>
                <p class="text-sm mt-2">Genera m√∫sica para ver los resultados aqu√≠</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Audio HTML5 Element -->
      <audio id="audioPlayer" preload="metadata"></audio>
    </div>
  </section>

  <!-- SECCI√ìN GHOST STUDIO -->
  <section id="ghost-studio" class="content-section section-hidden min-h-screen pt-20 pb-10" aria-hidden="true">
    <div class="mx-auto max-w-7xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Ghost Studio</h2>
        <p class="text-zinc-400 max-w-2xl mx-auto">Sube tu demo o escribe un prompt. El Estudio Fantasma devuelve una maqueta con mezcla y car√°cter.</p>
        <div class="inline-flex items-center space-x-2 mt-4">
          <div class="w-3 h-3 bg-neon rounded-full pulse-neon"></div>
          <span class="text-sm text-neon">online</span>
        </div>
      </div>
      
      <div class="max-w-4xl mx-auto">
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
          <div class="mb-8">
            <label class="block text-lg font-medium text-zinc-300 mb-4">Prompt de Generaci√≥n Musical</label>
            <textarea 
              class="w-full h-24 bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white resize-none"
              placeholder="Ej: una balada emotiva con piano y cuerdas, estilo neo-soul, tempo 70 BPM, voz masculina expresiva"
              id="promptGhostStudio"
            ></textarea>
          </div>
          
          <div class="mb-8">
            <label class="block text-lg font-medium text-zinc-300 mb-4">Preset</label>
            <select class="w-full bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white" id="presetGhost">
              <option>Profesional</option>
              <option>Experimental</option>
              <option>Vintage</option>
              <option>Crudo</option>
              <option>Cinematogr√°fico</option>
            </select>
          </div>
          
          <div class="mb-8">
            <label class="block text-lg font-medium text-zinc-300 mb-4">Tags/Estilo</label>
            <input 
              type="text" 
              class="w-full bg-zinc-900/50 border border-white/10 rounded-lg px-4 py-3 text-white"
              placeholder="pop, ballad, emotional, piano"
              id="tagsEstilo"
            >
          </div>
          
          <!-- Toggle instrumental a√±adido para Ghost Studio -->
          <div class="mb-8">
            <label class="inline-flex items-center gap-2">
              <input id="modoInstrumentalGhost" type="checkbox">
              <span class="text-sm text-zinc-300">Procesar instrumental</span>
            </label>
          </div>
          
          <div class="grid lg:grid-cols-2 gap-8 mb-8">
            <div>
              <h4 class="text-lg font-medium mb-4">Afinaci√≥n</h4>
              <div class="slider-container">
                <input type="range" class="custom-slider w-full" value="60" min="0" max="100" id="afinacionGhost">
                <p class="text-center text-sm text-zinc-400 mt-2">60%</p>
              </div>
            </div>
            
            <div>
              <h4 class="text-lg font-medium mb-4">Expresividad</h4>
              <div class="slider-container">
                <input type="range" class="custom-slider w-full" value="75" min="0" max="100" id="expresividadGhost">
                <p class="text-center text-sm text-zinc-400 mt-2">75%</p>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <button id="generarMusicaGhost" class="bg-neon text-black rounded-lg py-4 font-semibold text-lg hover:bg-neon/90 transition btn">
              Generar M√∫sica
            </button>
            <button id="verificarAPIs" class="border border-white/20 rounded-lg py-4 font-semibold hover:bg-white/5 transition btn">
              Verificar APIs
            </button>
          </div>
          <p class="text-xs text-zinc-400 text-center mt-2">* Funcionando en modo demo</p>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN EXTENSI√ìN -->
  <section id="extension" class="content-section section-hidden min-h-screen pt-20 pb-10" aria-hidden="true">
    <div class="mx-auto max-w-7xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Chrome Extension</h2>
        <p class="text-zinc-400 max-w-2xl mx-auto">Conecta Suno.com directamente con Son1k para enviar prompts musicales</p>
      </div>
      
      <div class="max-w-4xl mx-auto space-y-8">
        <!-- Extension Status -->
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
          <h3 class="text-xl font-semibold mb-6">Estado de la Extensi√≥n</h3>
          <div class="grid grid-cols-2 gap-6">
            <div class="space-y-4">
              <div class="flex items-center justify-between">
                <span>Conexi√≥n:</span>
                <span id="ext-connection-status" class="text-zinc-400">Desconectado</span>
              </div>
              <div class="flex items-center justify-between">
                <span>√öltimo ping:</span>
                <span id="ext-last-ping" class="text-zinc-400">Nunca</span>
              </div>
              <div class="flex items-center justify-between">
                <span>Backend URL:</span>
                <span class="text-neon text-sm">localhost:8000</span>
              </div>
            </div>
            <div class="space-y-4">
              <button class="w-full bg-neon/10 text-neon border border-neon rounded-lg py-3 hover:bg-neon/20 transition btn" onclick="testExtensionConnection()">
                üîç Probar Conexi√≥n
              </button>
              <button class="w-full bg-white/5 text-white border border-white/20 rounded-lg py-3 hover:bg-white/10 transition btn" onclick="openExtensionPage()">
                ‚öôÔ∏è Abrir Extensiones
              </button>
            </div>
          </div>
        </div>

        <!-- Extension Logs -->
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur-xl p-8">
          <h3 class="text-xl font-semibold mb-6">Logs de Extensi√≥n</h3>
          <div class="bg-zinc-900/50 border border-white/10 rounded-lg p-4 h-40 overflow-y-auto">
            <div id="extension-logs" class="space-y-1 text-sm text-zinc-400">
              <div>[INFO] Esperando conexi√≥n de extensi√≥n...</div>
            </div>
          </div>
        </div>

        <!-- Extension Guide -->
        <div class="rounded-2xl border border-neon/30 bg-gradient-to-br from-neon/5 to-neon-purple/5 p-8 backdrop-blur-xl">
          <h3 class="text-xl font-semibold mb-6">Gu√≠a de Instalaci√≥n</h3>
          <div class="space-y-4">
            <ol class="list-decimal list-inside space-y-2 text-zinc-300">
              <li>Open Chrome and go to <code>chrome://extensions/</code></li>
              <li>Enable "Developer mode" in the top right</li>
              <li>Click "Load unpacked" and select the extension folder</li>
              <li>Configure the extension popup with URL: <code>http://localhost:8000</code></li>
              <li>Visit <code>suno.com/create</code> to see the "Send to Son1k" button</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SECCI√ìN ARCHIVO -->
  <section id="archivo" class="content-section section-hidden min-h-screen pt-20 pb-10" aria-hidden="true">
    <div class="mx-auto max-w-7xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">El Archivo</h2>
        <p class="text-zinc-400 max-w-2xl mx-auto">Tu memoria creativa: canciones, presets y sesiones guardadas.</p>
        <button class="mt-4 text-neon hover:underline btn">Ver todo ‚Üí</button>
      </div>
      
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Ejemplo de archivo -->
        <div class="rounded-xl border border-white/10 bg-white/5 p-6 hover:bg-white/10 transition cursor-pointer">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Mi Canci√≥n Demo</h3>
            <span class="text-xs text-zinc-400">Hace 2 horas</span>
          </div>
          <p class="text-sm text-zinc-400 mb-4">Balada neo-soul con piano y cuerdas</p>
          <div class="flex space-x-2">
            <button class="text-xs bg-neon/10 text-neon px-3 py-1 rounded-full btn" data-play="true" data-src="#demo-audio">Reproducir</button>
            <button class="text-xs bg-white/5 text-white px-3 py-1 rounded-full btn">Descargar</button>
          </div>
        </div>
        
        <!-- M√°s archivos -->
        <div class="rounded-xl border border-white/10 bg-white/5 p-6 hover:bg-white/10 transition cursor-pointer">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Preset Experimental #1</h3>
            <span class="text-xs text-zinc-400">Ayer</span>
          </div>
          <p class="text-sm text-zinc-400 mb-4">Configuraci√≥n para trap mel√≥dico</p>
          <div class="flex space-x-2">
            <button class="text-xs bg-neon/10 text-neon px-3 py-1 rounded-full btn">Cargar</button>
            <button class="text-xs bg-white/5 text-white px-3 py-1 rounded-full btn">Duplicar</button>
          </div>
        </div>
        
        <div class="rounded-xl border border-white/10 bg-white/5 p-6 hover:bg-white/10 transition cursor-pointer">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">Sesi√≥n de voz clonada</h3>
            <span class="text-xs text-zinc-400">Hace 3 d√≠as</span>
          </div>
          <p class="text-sm text-zinc-400 mb-4">Voz APLIO "Nova" - expresividad alta</p>
          <div class="flex space-x-2">
            <button class="text-xs bg-neon/10 text-neon px-3 py-1 rounded-full btn" data-play="true" data-src="#demo-audio2">Reproducir</button>
            <button class="text-xs bg-white/5 text-white px-3 py-1 rounded-full btn">Reutilizar</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Variables globales
    let currentSection = 'home';
    let systemStatus = {
      api: false,
      celery: false,
      redis: false,
      extension: false
    };
    
    // API configurable para desarrollo y producci√≥n - MEJORADO
    const API_BASE_URL = (() => {
      const hostname = window.location.hostname;
      const protocol = window.location.protocol;
      const port = window.location.port;
      
      console.log('Detectando entorno:', { hostname, protocol, port });
      
      // Local development
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:8000';
      }
      
      // Ngrok tunnel (mejorada detecci√≥n)
      if (hostname.includes('ngrok') || hostname.includes('ngrok-free.app') || hostname.includes('ngrok.io')) {
        const baseUrl = `${protocol}//${hostname}${port ? ':' + port : ''}`;
        console.log('Entorno ngrok detectado:', baseUrl);
        return baseUrl;
      }
      
      // IPv4 local network (for mobile testing)
      if (hostname.match(/^192\.168\.|^10\.|^172\./)) {
        return `${protocol}//${hostname}:8000`;
      }
      
      // Production
      return 'https://son1kvers3.com';
    })();
    
    console.log('API_BASE_URL configurado:', API_BASE_URL);
    
    // Configuraci√≥n de knobs con soporte m√≥vil, teclado y ARIA
    function setupKnobs() {
      document.querySelectorAll('.knob').forEach(knob => {
        let isDragging = false;
        let startY = 0;
        let startValue = parseInt(knob.dataset.value) || 50;
        
        // Configurar ARIA
        knob.setAttribute('role', 'slider');
        knob.setAttribute('tabindex', '0');
        knob.setAttribute('aria-valuemin', '0');
        knob.setAttribute('aria-valuemax', '100');
        knob.setAttribute('aria-valuenow', startValue);
        
        // Establecer rotaci√≥n inicial
        updateKnobRotation(knob, startValue);
        
        // Funci√≥n para actualizar valor
        const setValue = (newValue) => {
          newValue = Math.min(100, Math.max(0, newValue));
          knob.dataset.value = newValue;
          knob.setAttribute('aria-valuenow', newValue);
          updateKnobRotation(knob, newValue);
          updateKnobDisplay(knob.dataset.knob, newValue);
        };
        
        // Mouse events
        knob.addEventListener('mousedown', (e) => {
          isDragging = true;
          startY = e.clientY;
          startValue = parseInt(knob.dataset.value) || 50;
          knob.style.cursor = 'grabbing';
          e.preventDefault();
        });
        
        // Touch events
        knob.addEventListener('touchstart', (e) => {
          isDragging = true;
          startY = e.touches[0].clientY;
          startValue = parseInt(knob.dataset.value) || 50;
        }, { passive: true });
        
        // Mouse move
        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          const deltaY = startY - e.clientY;
          const sensitivity = 1;
          setValue(startValue + deltaY * sensitivity);
        });
        
        // Touch move
        window.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          const deltaY = startY - e.touches[0].clientY;
          const sensitivity = 1;
          setValue(startValue + deltaY * sensitivity);
        }, { passive: true });
        
        // Mouse up
        document.addEventListener('mouseup', () => {
          if (isDragging) {
            isDragging = false;
            knob.style.cursor = 'pointer';
          }
        });
        
        // Touch end
        window.addEventListener('touchend', () => {
          isDragging = false;
        }, { passive: true });
        
        // Keyboard events
        knob.addEventListener('keydown', (e) => {
          const currentValue = parseInt(knob.dataset.value) || 50;
          
          if (['ArrowUp', 'ArrowRight'].includes(e.key)) {
            e.preventDefault();
            setValue(currentValue + 2);
          }
          if (['ArrowDown', 'ArrowLeft'].includes(e.key)) {
            e.preventDefault();
            setValue(currentValue - 2);
          }
          if (e.key === 'Home') {
            e.preventDefault();
            setValue(0);
          }
          if (e.key === 'End') {
            e.preventDefault();
            setValue(100);
          }
        });
      });
    }
    
    // Funci√≥n auxiliar para actualizar rotaci√≥n del knob
    function updateKnobRotation(knob, value) {
      const deg = -135 + (value / 100) * 270;
      knob.style.setProperty('--rotation', `${deg}deg`);
    }
    
    // Configuraci√≥n de sliders
    function setupSliders() {
      document.querySelectorAll('.custom-slider').forEach(slider => {
        const updateSlider = () => {
          const value = slider.value;
          slider.style.setProperty('--value', value + '%');
          
          // Actualizar display si existe
          const nextSibling = slider.parentNode.querySelector('p');
          if (nextSibling) {
            nextSibling.textContent = value + '%';
          }
        };
        
        slider.addEventListener('input', updateSlider);
        updateSlider(); // Inicializar
      });
    }
    
    // Actualizar displays de knobs
    function updateKnobDisplay(knobType, value) {
      const displays = {
        'expresividad': 'expresividadDisplay',
        'creatividad': 'creatividadDisplay',
        'precision': 'precisionDisplay',
        'expresividad-main': 'expresividadMainDisplay',
        'expresividad-gen': 'expresividadGenDisplay',
        'afinacion': 'afinacionDisplay'
      };
      
      const displayId = displays[knobType];
      if (displayId) {
        const display = document.getElementById(displayId);
        if (display) {
          display.textContent = Math.round(value) + '%';
        }
      }
    }
    
    // Navegaci√≥n entre secciones con ARIA
    function setupNavigation() {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const targetSection = e.target.dataset.section;
          showSection(targetSection);
          
          // Actualizar tabs con ARIA
          document.querySelectorAll('.nav-tab').forEach(t => {
            t.classList.remove('tab-active');
            t.setAttribute('aria-selected', 'false');
          });
          e.target.classList.add('tab-active');
          e.target.setAttribute('aria-selected', 'true');
        });
      });
    }
    
    function showSection(sectionName) {
      // Ocultar todas las secciones
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.add('section-hidden');
        section.setAttribute('aria-hidden', 'true');
      });
      
      // Mostrar la secci√≥n seleccionada
      const targetSection = document.getElementById(sectionName);
      if (targetSection) {
        targetSection.classList.remove('section-hidden');
        targetSection.setAttribute('aria-hidden', 'false');
        currentSection = sectionName;
      }
    }
    
    // Validaci√≥n de entradas
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                  .replace(/javascript:/gi, '')
                  .substring(0, 1000); // Limitar longitud
    }
    
    function validateUrl(url) {
      try {
        const parsed = new URL(url);
        return parsed.protocol === 'http:' || parsed.protocol === 'https:';
      } catch {
        return false;
      }
    }

    // AI Functions for Smart Prompts and Lyrics
    async function generarLetraIA() {
      const prompt = sanitizeInput(document.getElementById('promptEstilo').value);
      if (!prompt) {
        showToast('Ingresa un prompt de estilo primero para generar la letra', 'warning');
        return;
      }

      const btn = document.getElementById('generarLetraIA');
      btn.disabled = true;
      btn.textContent = 'ü§ñ Generando...';

      try {
        // Simular llamada de IA para generar letra
        const response = await fetch(`${API_BASE_URL}/api/generate-lyrics`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: prompt })
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('letraCancion').value = data.lyrics || "Letra generada basada en tu prompt...";
          showToast('¬°Letra generada con IA!', 'success');
        } else {
          // Fallback si no hay endpoint
          document.getElementById('letraCancion').value = "Verso 1:\n" + prompt + " me inspira\nCada nota que suena\nEn mi coraz√≥n vibra\n\nCoro:\nEsta es mi canci√≥n\nNacida del alma\nCon tu inspiraci√≥n\nHall√© la calma";
          showToast('Letra generada (modo demo)', 'info');
        }
      } catch (error) {
        // Fallback si hay error
        document.getElementById('letraCancion').value = "Verso 1:\n" + prompt + " me inspira\nCada nota que suena\nEn mi coraz√≥n vibra\n\nCoro:\nEsta es mi canci√≥n\nNacida del alma\nCon tu inspiraci√≥n\nHall√© la calma";
        showToast('Letra generada (modo demo)', 'info');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ü§ñ Generar Letra con IA';
      }
    }

    async function mejorarLetra() {
      const letra = sanitizeInput(document.getElementById('letraCancion').value);
      if (!letra) {
        showToast('Escribe una letra primero para mejorarla', 'warning');
        return;
      }

      const btn = document.getElementById('mejorarLetra');
      btn.disabled = true;
      btn.textContent = '‚ú® Mejorando...';

      try {
        const response = await fetch(`${API_BASE_URL}/api/improve-lyrics`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lyrics: letra })
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('letraCancion').value = data.improved_lyrics || letra;
          showToast('¬°Letra mejorada!', 'success');
        } else {
          showToast('Letra procesada (modo demo)', 'info');
        }
      } catch (error) {
        showToast('Error al mejorar letra', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '‚ú® Mejorar Letra';
      }
    }

    async function promptInteligente() {
      const letra = sanitizeInput(document.getElementById('letraCancion').value);
      
      const btn = document.getElementById('promptInteligente');
      btn.disabled = true;
      btn.textContent = 'üéØ Analizando...';

      try {
        const response = await fetch(`${API_BASE_URL}/api/smart-prompt`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lyrics: letra })
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('promptEstilo').value = data.smart_prompt || '';
          showToast('¬°Prompt inteligente generado!', 'success');
        } else {
          // Fallback inteligente basado en an√°lisis b√°sico
          let prompt = "Una canci√≥n ";
          if (letra.toLowerCase().includes('amor')) prompt += "rom√°ntica ";
          if (letra.toLowerCase().includes('triste')) prompt += "melanc√≥lica ";
          if (letra.toLowerCase().includes('alegr')) prompt += "alegre ";
          if (letra.toLowerCase().includes('rock')) prompt += "con estilo rock ";
          prompt += "con expresi√≥n emocional, tempo medio";
          
          document.getElementById('promptEstilo').value = prompt;
          showToast('Prompt inteligente generado (an√°lisis b√°sico)', 'info');
        }
      } catch (error) {
        // Fallback b√°sico
        document.getElementById('promptEstilo').value = "Una balada emotiva con instrumentaci√≥n rica, tempo medio, expresi√≥n vocal intensa";
        showToast('Prompt generado (modo demo)', 'info');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üéØ Prompt Inteligente';
      }
    }

    async function analizarTexto() {
      const letra = sanitizeInput(document.getElementById('letraCancion').value);
      if (!letra) {
        showToast('Escribe una letra primero para analizarla', 'warning');
        return;
      }

      const btn = document.getElementById('analizarTexto');
      btn.disabled = true;
      btn.textContent = 'üìä Analizando...';

      // An√°lisis b√°sico del texto
      const words = letra.toLowerCase().split(/\s+/);
      const sentiment = {
        positive: ['amor', 'feliz', 'alegr', 'bien', 'bueno', 'genial', 'perfecto'],
        negative: ['triste', 'dolor', 'mal', 'terrible', 'horrible', 'llorar'],
        emotional: ['coraz√≥n', 'alma', 'sentir', 'emoci', 'profund']
      };

      let analysis = "An√°lisis de la letra:\n";
      analysis += `‚Ä¢ Palabras: ${words.length}\n`;
      
      const positiveCount = sentiment.positive.filter(w => letra.toLowerCase().includes(w)).length;
      const negativeCount = sentiment.negative.filter(w => letra.toLowerCase().includes(w)).length;
      const emotionalCount = sentiment.emotional.filter(w => letra.toLowerCase().includes(w)).length;

      if (positiveCount > negativeCount) analysis += "‚Ä¢ Tono: Positivo/Optimista\n";
      else if (negativeCount > positiveCount) analysis += "‚Ä¢ Tono: Melanc√≥lico/Introspectivo\n";
      else analysis += "‚Ä¢ Tono: Neutro/Equilibrado\n";

      if (emotionalCount > 2) analysis += "‚Ä¢ Intensidad emocional: Alta\n";
      else analysis += "‚Ä¢ Intensidad emocional: Media\n";

      analysis += "‚Ä¢ Recomendaci√≥n: ";
      if (positiveCount > negativeCount) analysis += "Tempo alegre, instrumentaci√≥n brillante";
      else analysis += "Tempo lento, instrumentaci√≥n intimista";

      showToast(analysis, 'info');
      
      btn.disabled = false;
      btn.textContent = 'üìä Analizar Texto';
    }
    
    // Funciones de generaci√≥n musical con validaci√≥n MEJORADA
    async function generarMusica() {
      try {
        const esInstrumental = document.getElementById('modoInstrumental').checked;
        const letra = sanitizeInput(document.getElementById('letraCancion').value);
        const estilo = sanitizeInput(document.getElementById('promptEstilo').value);
        const preset = document.getElementById('presetGeneracion').value;
        
        if (!esInstrumental && !letra && !estilo) {
          showToast('Por favor ingresa una letra o prompt de estilo, o activa modo instrumental', 'warning');
          return;
        }
        
        if (esInstrumental && !estilo) {
          showToast('Por favor ingresa un prompt de estilo para el instrumental', 'warning');
          return;
        }
        
        const btn = document.getElementById('generarMusica');
        btn.disabled = true;
        btn.textContent = esInstrumental ? 'Generando instrumental...' : 'Generando canci√≥n...';
        
        console.log('Enviando request a:', `${API_BASE_URL}/api/music/generate`);
        
        // Usar endpoint simplificado sin autenticaci√≥n requerida
        const response = await fetch(`${API_BASE_URL}/api/music/generate`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'ngrok-skip-browser-warning': 'true'
          },
          body: JSON.stringify({
            prompt: estilo || 'm√∫sica instrumental',
            lyrics: letra,
            instrumental: esInstrumental,
            style: preset
          })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          throw new Error(`Error HTTP: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.job_id) {
          showToast(`¬°Tarea encolada! ID: ${data.job_id}`, 'success');
          addLog(`üéµ Generando m√∫sica - Job ID: ${data.job_id}`);
        } else {
          showToast(esInstrumental ? '¬°Instrumental generado con √©xito!' : '¬°M√∫sica generada con √©xito!', 'success');
        }
      } catch (error) {
        console.error('Error completo:', error);
        showToast('Error al generar m√∫sica: ' + error.message, 'error');
        addLog(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        const btn = document.getElementById('generarMusica');
        btn.disabled = false;
        btn.textContent = 'Generar M√∫sica';
      }
    }
    
    async function generarMusicaGhost() {
      try {
        const esInstrumental = document.getElementById('modoInstrumentalGhost').checked;
        const prompt = sanitizeInput(document.getElementById('promptGhostStudio').value);
        const preset = document.getElementById('presetGhost').value;
        const tags = sanitizeInput(document.getElementById('tagsEstilo').value);
        
        if (!prompt) {
          showToast('Por favor ingresa un prompt para Ghost Studio', 'warning');
          return;
        }
        
        const btn = document.getElementById('generarMusicaGhost');
        btn.disabled = true;
        btn.textContent = esInstrumental ? 'Procesando instrumental en Ghost Studio...' : 'Procesando en Ghost Studio...';
        
        // Usar endpoint simplificado sin autenticaci√≥n requerida
        const response = await fetch(`${API_BASE_URL}/api/music/generate`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'ngrok-skip-browser-warning': 'true'
          },
          body: JSON.stringify({
            prompt: prompt,
            instrumental: esInstrumental,
            style: `${preset} ${tags}`.trim()
          })
        });
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.job_id) {
          showToast(`¬°Ghost Studio procesando! ID: ${data.job_id}`, 'success');
          addLog(`üëª Ghost Studio procesando - Job ID: ${data.job_id}`);
        } else {
          showToast(esInstrumental ? '¬°Instrumental procesado por Ghost Studio!' : '¬°Maqueta procesada por Ghost Studio!', 'success');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error en Ghost Studio: ' + error.message, 'error');
      } finally {
        const btn = document.getElementById('generarMusicaGhost');
        btn.disabled = false;
        btn.textContent = 'Generar M√∫sica';
      }
    }

    // ================================
    // AUDIO PLAYER & WEBSOCKET SYSTEM
    // ================================
    
    let audioPlayer = null;
    let currentTrack = null;
    let audioLibraryData = [];
    let websocket = null;
    let currentJobId = null;
    
    // Initialize Audio Player System
    function initializeAudioPlayer() {
      audioPlayer = document.getElementById('audioPlayer');
      
      // Audio player event listeners
      audioPlayer.addEventListener('loadedmetadata', updateTrackInfo);
      audioPlayer.addEventListener('timeupdate', updateProgress);
      audioPlayer.addEventListener('ended', onTrackEnded);
      audioPlayer.addEventListener('error', onAudioError);
      
      // Player controls
      document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
      document.getElementById('progressSlider').addEventListener('input', seekTrack);
      document.getElementById('volumeSlider').addEventListener('input', updateVolume);
      
      // Control buttons
      document.getElementById('downloadCurrentBtn').addEventListener('click', downloadCurrentTrack);
      document.getElementById('deleteBtn').addEventListener('click', deleteCurrentTrack);
      document.getElementById('refreshLibraryBtn').addEventListener('click', refreshAudioLibrary);
      document.getElementById('cleanupBtn').addEventListener('click', cleanupOldFiles);
      
      // Initialize volume
      audioPlayer.volume = 0.5;
      
      // Load initial library
      refreshAudioLibrary();
    }
    
    // WebSocket Management
    function initializeWebSocket() {
      if (!currentUser) return;
      
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${wsProtocol}//${window.location.host}/ws/ws/${currentUser.id}`;
      
      try {
        websocket = new WebSocket(wsUrl);
        
        websocket.onopen = () => {
          console.log('WebSocket connected');
          updateWebSocketStatus(true);
        };
        
        websocket.onmessage = (event) => {
          const message = JSON.parse(event.data);
          handleWebSocketMessage(message);
        };
        
        websocket.onclose = () => {
          console.log('WebSocket disconnected');
          updateWebSocketStatus(false);
          // Attempt to reconnect after 5 seconds
          setTimeout(initializeWebSocket, 5000);
        };
        
        websocket.onerror = (error) => {
          console.error('WebSocket error:', error);
          updateWebSocketStatus(false);
        };
        
      } catch (error) {
        console.error('Failed to initialize WebSocket:', error);
        updateWebSocketStatus(false);
      }
    }
    
    function handleWebSocketMessage(message) {
      console.log('WebSocket message:', message);
      
      switch (message.type) {
        case 'job_status':
        case 'job_update':
          updateJobProgress(message);
          break;
        case 'queue_position':
          updateQueuePosition(message);
          break;
        case 'pong':
          console.log('WebSocket ping/pong OK');
          break;
        default:
          console.log('Unknown message type:', message.type);
      }
    }
    
    function updateWebSocketStatus(connected) {
      const statusElement = document.getElementById('wsStatus');
      if (statusElement) {
        statusElement.className = `w-3 h-3 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`;
      }
    }
    
    function subscribeToJob(jobId) {
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        currentJobId = jobId;
        websocket.send(JSON.stringify({
          type: 'subscribe_job',
          job_id: jobId
        }));
        
        // Show progress tracking
        showJobProgress(jobId);
      }
    }
    
    function showJobProgress(jobId) {
      const progressContainer = document.getElementById('jobProgress');
      if (progressContainer) {
        progressContainer.style.display = 'block';
        document.getElementById('currentJobId').textContent = jobId;
        document.getElementById('currentJobStatus').textContent = 'iniciado';
      }
      
      // Navigate to results section
      showSection('resultados');
    }
    
    function updateJobProgress(message) {
      const progress = message.progress || 0;
      const statusMessage = message.message || 'Procesando...';
      const status = message.status || 'processing';
      
      // Update progress bar
      const progressBar = document.getElementById('progressBar');
      const progressPercent = document.getElementById('progressPercent');
      const progressMessage = document.getElementById('progressMessage');
      const jobStatus = document.getElementById('currentJobStatus');
      
      if (progressBar) progressBar.style.width = `${progress}%`;
      if (progressPercent) progressPercent.textContent = `${progress}%`;
      if (progressMessage) progressMessage.textContent = statusMessage;
      if (jobStatus) jobStatus.textContent = status;
      
      // Handle completion
      if (status === 'completed') {
        showToast('¬°Generaci√≥n completada!', 'success');
        setTimeout(() => {
          document.getElementById('jobProgress').style.display = 'none';
          refreshAudioLibrary();
        }, 3000);
      } else if (status === 'failed') {
        showToast(`Generaci√≥n fall√≥: ${statusMessage}`, 'error');
        setTimeout(() => {
          document.getElementById('jobProgress').style.display = 'none';
        }, 5000);
      }
    }
    
    // Audio Library Management
    async function refreshAudioLibrary() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/audio/files`);
        if (response.ok) {
          const data = await response.json();
          audioLibraryData = data.files || [];
          renderAudioLibrary();
        } else {
          console.error('Failed to fetch audio library');
        }
      } catch (error) {
        console.error('Error fetching audio library:', error);
      }
    }
    
    function renderAudioLibrary() {
      const container = document.getElementById('audioLibrary');
      
      if (audioLibraryData.length === 0) {
        container.innerHTML = `
          <div class="text-center text-zinc-400 py-8">
            <p>No hay archivos de audio disponibles</p>
            <p class="text-sm mt-2">Genera m√∫sica para ver los resultados aqu√≠</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = audioLibraryData.map(file => `
        <div class="bg-zinc-900/30 rounded-lg p-4 flex items-center justify-between hover:bg-zinc-900/50 transition audio-file-item" 
             data-filename="${file.filename}">
          <div class="flex items-center space-x-4">
            <button class="w-10 h-10 bg-neon/20 rounded-full flex items-center justify-center text-neon hover:bg-neon/30 transition play-btn"
                    onclick="loadTrack('${file.filename}')">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>
            <div>
              <p class="font-medium">${file.filename}</p>
              <p class="text-sm text-zinc-400">${formatFileSize(file.size)} ‚Ä¢ ${formatDate(file.created)}</p>
            </div>
          </div>
          <div class="flex space-x-2">
            <button onclick="downloadFile('${file.filename}')" 
                    class="text-neon hover:text-neon/80 transition text-sm">
              üì•
            </button>
            <button onclick="deleteFile('${file.filename}')" 
                    class="text-red-400 hover:text-red-300 transition text-sm">
              üóëÔ∏è
            </button>
          </div>
        </div>
      `).join('');
    }
    
    // Audio Player Functions
    async function loadTrack(filename) {
      try {
        currentTrack = audioLibraryData.find(f => f.filename === filename);
        if (!currentTrack) return;
        
        const streamUrl = `${API_BASE_URL}/api/audio/stream/${filename}`;
        audioPlayer.src = streamUrl;
        
        // Update UI
        document.getElementById('currentTrackName').textContent = filename;
        document.getElementById('mainPlayer').style.display = 'block';
        
        // Enable controls
        ['downloadCurrentBtn', 'shareBtn', 'deleteBtn'].forEach(id => {
          document.getElementById(id).disabled = false;
        });
        
        // Load metadata
        loadTrackMetadata(filename);
        
      } catch (error) {
        console.error('Error loading track:', error);
        showToast('Error al cargar el archivo de audio', 'error');
      }
    }
    
    async function loadTrackMetadata(filename) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/audio/metadata/${filename}`);
        if (response.ok) {
          const metadata = await response.json();
          
          document.getElementById('fileName').textContent = metadata.filename;
          document.getElementById('fileSize').textContent = formatFileSize(metadata.size);
          document.getElementById('fileFormat').textContent = metadata.extension.toUpperCase();
          document.getElementById('generatedAt').textContent = formatDate(metadata.created);
        }
      } catch (error) {
        console.error('Error loading metadata:', error);
      }
    }
    
    function togglePlayPause() {
      if (audioPlayer.paused) {
        audioPlayer.play();
        document.getElementById('playIcon').classList.add('hidden');
        document.getElementById('pauseIcon').classList.remove('hidden');
      } else {
        audioPlayer.pause();
        document.getElementById('playIcon').classList.remove('hidden');
        document.getElementById('pauseIcon').classList.add('hidden');
      }
    }
    
    function updateTrackInfo() {
      const duration = audioPlayer.duration;
      if (duration) {
        document.getElementById('totalTime').textContent = formatTime(duration);
        document.getElementById('trackDuration').textContent = formatTime(duration);
        document.getElementById('progressSlider').max = duration;
      }
    }
    
    function updateProgress() {
      const currentTime = audioPlayer.currentTime;
      const duration = audioPlayer.duration;
      
      if (duration) {
        const progress = (currentTime / duration) * 100;
        document.getElementById('progressSlider').value = currentTime;
        document.getElementById('currentTime').textContent = formatTime(currentTime);
      }
    }
    
    function seekTrack() {
      const value = document.getElementById('progressSlider').value;
      audioPlayer.currentTime = value;
    }
    
    function updateVolume() {
      const value = document.getElementById('volumeSlider').value / 100;
      audioPlayer.volume = value;
    }
    
    function onTrackEnded() {
      document.getElementById('playIcon').classList.remove('hidden');
      document.getElementById('pauseIcon').classList.add('hidden');
    }
    
    function onAudioError(error) {
      console.error('Audio error:', error);
      showToast('Error al reproducir el archivo de audio', 'error');
    }
    
    // File Management Functions
    async function downloadFile(filename) {
      const url = `${API_BASE_URL}/api/audio/download/${filename}`;
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    
    function downloadCurrentTrack() {
      if (currentTrack) {
        downloadFile(currentTrack.filename);
      }
    }
    
    async function deleteFile(filename) {
      if (!confirm(`¬øEst√°s seguro de que quieres eliminar ${filename}?`)) return;
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/audio/delete/${filename}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showToast('Archivo eliminado correctamente', 'success');
          refreshAudioLibrary();
          
          // If current track was deleted, clear player
          if (currentTrack && currentTrack.filename === filename) {
            clearPlayer();
          }
        } else {
          showToast('Error al eliminar el archivo', 'error');
        }
      } catch (error) {
        console.error('Error deleting file:', error);
        showToast('Error al eliminar el archivo', 'error');
      }
    }
    
    function deleteCurrentTrack() {
      if (currentTrack) {
        deleteFile(currentTrack.filename);
      }
    }
    
    async function cleanupOldFiles() {
      if (!confirm('¬øEst√°s seguro de que quieres limpiar archivos antiguos?')) return;
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/audio/cleanup`, {
          method: 'POST'
        });
        
        if (response.ok) {
          const data = await response.json();
          showToast(`Limpieza completada. ${data.deleted_files} archivos eliminados`, 'success');
          refreshAudioLibrary();
        } else {
          showToast('Error durante la limpieza', 'error');
        }
      } catch (error) {
        console.error('Error during cleanup:', error);
        showToast('Error durante la limpieza', 'error');
      }
    }
    
    function clearPlayer() {
      audioPlayer.src = '';
      currentTrack = null;
      document.getElementById('mainPlayer').style.display = 'none';
      document.getElementById('currentTrackName').textContent = 'Sin audio seleccionado';
      
      // Disable controls
      ['downloadCurrentBtn', 'shareBtn', 'deleteBtn'].forEach(id => {
        document.getElementById(id).disabled = true;
      });
    }
    
    // Utility Functions
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);
      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    function formatDate(timestamp) {
      return new Date(timestamp * 1000).toLocaleDateString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // Enhanced Music Generation with Audio Player Integration
    async function generarMusicaConAudio() {
      try {
        const response = await generarMusica();
        
        if (response && response.job_id) {
          // Subscribe to WebSocket updates for this job
          subscribeToJob(response.job_id);
        }
        
        return response;
      } catch (error) {
        console.error('Error in enhanced music generation:', error);
        throw error;
      }
    }
    
    // System Status Functions
    async function checkSystemStatus() {
      try {
        // Check API
        const apiResponse = await fetch(`${API_BASE_URL}/api/health`);
        systemStatus.api = apiResponse.ok;

        // Check Celery (through backend endpoint if available)
        try {
          const celeryResponse = await fetch(`${API_BASE_URL}/api/celery-status`);
          systemStatus.celery = celeryResponse.ok;
        } catch {
          systemStatus.celery = false;
        }

        // Check Redis (through backend endpoint if available)
        try {
          const redisResponse = await fetch(`${API_BASE_URL}/api/redis-status`);
          systemStatus.redis = redisResponse.ok;
        } catch {
          systemStatus.redis = false;
        }

        // Check Chrome Extension - improved detection
        try {
          // Method 1: Check if extension has communicated recently
          const hasExtensionStorage = localStorage.getItem('son1k_extension_connected');
          const extensionTimestamp = localStorage.getItem('son1k_extension_timestamp');
          
          // Method 2: Post message to potential extension
          window.postMessage({ 
            type: 'SON1K_FRONTEND_PING', 
            timestamp: Date.now(),
            source: 'son1k_frontend'
          }, '*');
          
          // Method 3: Check for extension-specific indicators
          const extensionIndicators = [
            hasExtensionStorage === 'true',
            extensionTimestamp && (Date.now() - parseInt(extensionTimestamp)) < 60000, // Last ping within 60 seconds
            document.querySelector('[data-son1k-extension]') !== null
          ];
          
          systemStatus.extension = extensionIndicators.some(indicator => indicator);
          
          if (systemStatus.extension) {
            addLog('‚úÖ Extensi√≥n Chrome detectada', 'success');
          }
          
        } catch {
          systemStatus.extension = false;
        }

        updateStatusIndicators();
      } catch (error) {
        systemStatus.api = false;
        systemStatus.celery = false;
        systemStatus.redis = false;
        systemStatus.extension = false;
        updateStatusIndicators();
      }
    }

    function updateStatusIndicators() {
      const indicators = {
        'api-status': systemStatus.api,
        'celery-status': systemStatus.celery,
        'redis-status': systemStatus.redis,
        'extension-status': systemStatus.extension
      };

      Object.entries(indicators).forEach(([id, status]) => {
        const element = document.getElementById(id);
        if (element) {
          element.className = `status-indicator ${status ? 'status-online' : 'status-offline'}`;
        }
      });
    }

    function refreshSystemStatus() {
      addLog('üîÑ Refrescando estado del sistema...');
      checkSystemStatus();
    }

    function addLog(message, type = 'info') {
      const logs = document.getElementById('extension-logs');
      if (logs) {
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logEntry.className = `text-${type === 'error' ? 'red' : type === 'success' ? 'green' : 'zinc'}-400`;
        logs.appendChild(logEntry);
        logs.scrollTop = logs.scrollHeight;
      }
    }

    function testExtensionConnection() {
      addLog('üîç Probando conexi√≥n de extensi√≥n...');
      window.postMessage({ type: 'BACKEND_PING', url: window.location.origin }, '*');
      
      setTimeout(() => {
        if (!systemStatus.extension) {
          addLog('‚ö†Ô∏è No hay respuesta de la extensi√≥n', 'error');
        }
      }, 2000);
    }

    function openExtensionPage() {
      window.open('chrome://extensions/', '_blank');
    }

    // Extension Communication
    window.addEventListener('message', (event) => {
      if (event.data.type === 'EXTENSION_PING') {
        systemStatus.extension = true;
        updateStatusIndicators();
        addLog('üîå ¬°Extensi√≥n conectada!', 'success');
        
        document.getElementById('ext-connection-status').textContent = 'Conectado';
        document.getElementById('ext-last-ping').textContent = new Date().toLocaleTimeString();
      }
    });

    // Auto-refresh extension status
    setInterval(() => {
      const lastPing = document.getElementById('ext-last-ping').textContent;
      if (lastPing !== 'Nunca') {
        const lastTime = new Date('1970-01-01 ' + lastPing);
        const now = new Date();
        const diff = (now.getTime() - lastTime.getTime()) / 1000;
        
        if (diff > 60) { // More than 1 minute since last ping
          systemStatus.extension = false;
          updateStatusIndicators();
          document.getElementById('ext-connection-status').textContent = 'Desconectado';
        }
      }
    }, 10000);
    
    // Sistema de notificaciones mejorado
    function showToast(message, type = 'info') {
      const toastArea = document.getElementById('toast-area');
      const toast = document.createElement('div');
      toast.className = `fixed top-24 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium max-w-sm transform transition-all duration-300 translate-x-full`;
      
      const colors = {
        'success': 'bg-green-600',
        'error': 'bg-red-600',
        'warning': 'bg-yellow-600',
        'info': 'bg-blue-600'
      };
      
      toast.classList.add(colors[type] || colors.info);
      
      // Crear nodo de texto seguro (sin innerHTML)
      const textNode = document.createTextNode(message);
      toast.appendChild(textNode);
      
      toastArea.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('translate-x-full');
      }, 100);
      
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
          if (toast.parentNode) {
            toastArea.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }
    
    // Event listeners principales
    function setupEventListeners() {
      // Botones principales
      document.getElementById('testRapido').addEventListener('click', () => {
        showToast('Test R√°pido iniciado', 'info');
        checkSystemStatus();
      });
      
      document.getElementById('generarPreview').addEventListener('click', () => {
        showToast('Generando preview...', 'info');
      });
      
      document.getElementById('entrarEstudio').addEventListener('click', () => {
        showSection('generacion');
        document.querySelectorAll('.nav-tab').forEach(t => {
          t.classList.remove('tab-active');
          t.setAttribute('aria-selected', 'false');
        });
        const tab = document.querySelector('[data-section="generacion"]');
        tab.classList.add('tab-active');
        tab.setAttribute('aria-selected', 'true');
      });
      
      document.getElementById('entrarEstudioMain').addEventListener('click', () => {
        showSection('generacion');
        document.querySelectorAll('.nav-tab').forEach(t => {
          t.classList.remove('tab-active');
          t.setAttribute('aria-selected', 'false');
        });
        const tab = document.querySelector('[data-section="generacion"]');
        tab.classList.add('tab-active');
        tab.setAttribute('aria-selected', 'true');
      });
      
      document.getElementById('conocerUniverso').addEventListener('click', () => {
        showSection('home');
        window.scrollTo({ top: document.getElementById('home').offsetHeight, behavior: 'smooth' });
      });
      
      // Smart prompt buttons
      document.getElementById('generarLetraIA').addEventListener('click', generarLetraIA);
      document.getElementById('mejorarLetra').addEventListener('click', mejorarLetra);
      document.getElementById('promptInteligente').addEventListener('click', promptInteligente);
      document.getElementById('analizarTexto').addEventListener('click', analizarTexto);
      
      // Botones de generaci√≥n
      document.getElementById('generarMusica').addEventListener('click', generarMusica);
      document.getElementById('generarMusicaGhost').addEventListener('click', generarMusicaGhost);
      
      document.getElementById('verificarAPIs').addEventListener('click', async () => {
        showToast('Verificando conexiones de API...', 'info');
        await checkSystemStatus();
        if (systemStatus.api) {
          showToast('APIs conectadas correctamente', 'success');
        } else {
          showToast('Problemas de conectividad detectados', 'warning');
        }
      });
    }
    
    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', async () => {
      setupKnobs();
      setupSliders();
      setupNavigation();
      setupEventListeners();
      
      // Initialize audio player system
      initializeAudioPlayer();
      
      // Initialize WebSocket (if user is logged in)
      if (currentUser) {
        initializeWebSocket();
      }
      
      // Verificar sistema
      await checkSystemStatus();
      
      // Send message to potential extension
      window.postMessage({ type: 'BACKEND_PING', url: window.location.origin }, '*');
      
      setTimeout(() => {
        if (!systemStatus.extension) {
          addLog('‚ö†Ô∏è No hay respuesta de extensi√≥n. Verifica que est√© instalada.', 'warning');
        }
      }, 2000);
      
      // Mensaje de bienvenida
      setTimeout(() => {
        showToast('Bienvenido a Son1kVers3 - La Resistencia Sonora', 'success');
      }, 1000);
    });

    // ================================
    // SISTEMA DE AUTENTICACI√ìN
    // ================================

    // Variables globales de autenticaci√≥n
    let currentUser = null;
    let authToken = localStorage.getItem('authToken');

    // Verificar autenticaci√≥n al cargar
    if (authToken) {
      verifyToken();
    }

    // Funci√≥n para mostrar modal de login
    function showLoginModal() {
      document.getElementById('authModal').style.display = 'flex';
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('registerForm').style.display = 'none';
    }

    // Funci√≥n para mostrar modal de registro
    function showRegisterModal() {
      document.getElementById('authModal').style.display = 'flex';
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
    }

    // Funci√≥n para cerrar modal
    function closeAuthModal() {
      document.getElementById('authModal').style.display = 'none';
    }

    // Funci√≥n de login
    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        showToast('Por favor completa todos los campos', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/api/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
          authToken = data.access_token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          updateAuthUI();
          closeAuthModal();
          showToast(`¬°Bienvenido ${currentUser.email}! Plan: ${currentUser.plan.toUpperCase()}`, 'success');
        } else {
          showToast(data.detail || 'Error en el login', 'error');
        }
      } catch (error) {
        showToast('Error de conexi√≥n', 'error');
        console.error('Login error:', error);
      }
    }

    // Funci√≥n de registro
    async function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const name = document.getElementById('registerName').value;

      if (!email || !password) {
        showToast('Email y contrase√±a son obligatorios', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password, name })
        });

        const data = await response.json();

        if (response.ok) {
          authToken = data.access_token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          updateAuthUI();
          closeAuthModal();
          showToast(`¬°Cuenta creada! Bienvenido ${currentUser.email}`, 'success');
        } else {
          showToast(data.detail || 'Error en el registro', 'error');
        }
      } catch (error) {
        showToast('Error de conexi√≥n', 'error');
        console.error('Register error:', error);
      }
    }

    // Funci√≥n de logout
    function logout() {
      authToken = null;
      currentUser = null;
      localStorage.removeItem('authToken');
      updateAuthUI();
      showToast('Sesi√≥n cerrada', 'info');
    }

    // Verificar token v√°lido
    async function verifyToken() {
      if (!authToken) return;

      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/me`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          currentUser = await response.json();
          updateAuthUI();
        } else {
          // Token inv√°lido
          logout();
        }
      } catch (error) {
        console.error('Token verification error:', error);
        logout();
      }
    }

    // Actualizar UI seg√∫n estado de autenticaci√≥n
    function updateAuthUI() {
      const authButtons = document.getElementById('authButtons');
      const userInfo = document.getElementById('userInfo');

      if (currentUser) {
        authButtons.style.display = 'none';
        userInfo.style.display = 'block';
        userInfo.innerHTML = `
          <div class="flex items-center space-x-4">
            <div class="text-right">
              <div class="text-sm font-medium">${currentUser.email}</div>
              <div class="text-xs text-neon">${currentUser.plan.toUpperCase()} - ${currentUser.daily_usage}/${currentUser.daily_limit} hoy</div>
            </div>
            <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm">
              Salir
            </button>
          </div>
        `;
      } else {
        authButtons.style.display = 'block';
        userInfo.style.display = 'none';
      }
    }

    // Configurar eventos de autenticaci√≥n cuando se hace clic en "Entrar al Estudio"
    document.getElementById('entrarEstudio').addEventListener('click', () => {
      if (!currentUser) {
        showLoginModal();
      } else {
        // Usuario autenticado, ir al estudio
        const tabButton = document.querySelector('[data-section="estudio"]');
        if (tabButton) {
          tabButton.click();
        }
      }
    });

    document.getElementById('entrarEstudioMain').addEventListener('click', () => {
      if (!currentUser) {
        showLoginModal();
      } else {
        // Usuario autenticado, ir al estudio
        const tabButton = document.querySelector('[data-section="estudio"]');
        if (tabButton) {
          tabButton.click();
        }
      }
    });

    // ================================
    // PROTECCI√ìN OBLIGATORIA DE AUTENTICACI√ìN
    // ================================

    // Interceptar todos los clicks en tabs para requerir autenticaci√≥n
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        const section = tab.getAttribute('data-section');
        
        // Secciones que requieren autenticaci√≥n
        const protectedSections = ['estudio', 'extension', 'archivo'];
        
        if (protectedSections.includes(section) && !currentUser) {
          e.preventDefault();
          e.stopPropagation();
          showLoginModal();
          showToast('Debes iniciar sesi√≥n para acceder a esta secci√≥n', 'error');
          return false;
        }
      });
    });

    // Proteger funciones de generaci√≥n
    const originalGenerateFunction = window.generarCancion;
    window.generarCancion = function() {
      if (!currentUser) {
        showLoginModal();
        showToast('Debes iniciar sesi√≥n para generar m√∫sica', 'error');
        return;
      }
      return originalGenerateFunction.apply(this, arguments);
    };

    // Proteger funci√≥n de env√≠o
    const originalSendFunction = window.enviarASuno;
    window.enviarASuno = function() {
      if (!currentUser) {
        showLoginModal();
        showToast('Debes iniciar sesi√≥n para enviar a Suno', 'error');
        return;
      }
      return originalSendFunction.apply(this, arguments);
    };

    // A√±adir headers de autorizaci√≥n a todas las requests API
    function makeAuthenticatedRequest(endpoint, options = {}) {
      if (!currentUser || !authToken) {
        showLoginModal();
        throw new Error('Autenticaci√≥n requerida');
      }

      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`,
          ...options.headers
        },
        ...options
      };

      return fetch(`${API_BASE_URL}${endpoint}`, defaultOptions);
    }

    // Reemplazar funci√≥n global de fetch para endpoints protegidos
    const originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
      // Si es una llamada a API de songs, requerir autenticaci√≥n
      if (url.includes('/api/songs/') || url.includes('/api/auth/me')) {
        if (!currentUser || !authToken) {
          showLoginModal();
          return Promise.reject(new Error('Autenticaci√≥n requerida'));
        }
        
        // A√±adir token de autorizaci√≥n
        options.headers = {
          ...options.headers,
          'Authorization': `Bearer ${authToken}`
        };
      }
      
      return originalFetch.call(this, url, options);
    };

    // Verificar autenticaci√≥n al inicializar
    function checkAuthenticationOnLoad() {
      if (authToken) {
        verifyToken();
      } else {
        // Si no hay token, mostrar modal despu√©s de un breve delay
        setTimeout(() => {
          if (!currentUser) {
            showToast('¬°Bienvenido! Inicia sesi√≥n para usar todas las funciones', 'info');
          }
        }, 3000);
      }
    }

    // Ejecutar verificaci√≥n al cargar
    checkAuthenticationOnLoad();
  </script>

  <!-- Modal de Autenticaci√≥n -->
  <div id="authModal" style="display: none;" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
    <div class="bg-zinc-900 p-8 rounded-xl border border-white/20 max-w-md w-full mx-4">
      
      <!-- Formulario de Login -->
      <div id="loginForm">
        <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesi√≥n</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Email</label>
            <input 
              type="email" 
              id="loginEmail" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="tu@email.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Contrase√±a</label>
            <input 
              type="password" 
              id="loginPassword" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>
          <button 
            onclick="login()" 
            class="w-full bg-neon text-black py-3 rounded-lg font-semibold hover:bg-neon/90 transition"
          >
            Entrar
          </button>
          <div class="text-center">
            <button onclick="showRegisterModal()" class="text-neon hover:underline">
              ¬øNo tienes cuenta? Reg√≠strate
            </button>
          </div>
        </div>
      </div>

      <!-- Formulario de Registro -->
      <div id="registerForm" style="display: none;">
        <h2 class="text-2xl font-bold text-center mb-6">Crear Cuenta</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Nombre (opcional)</label>
            <input 
              type="text" 
              id="registerName" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="Tu nombre"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Email</label>
            <input 
              type="email" 
              id="registerEmail" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="tu@email.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Contrase√±a</label>
            <input 
              type="password" 
              id="registerPassword" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>
          <button 
            onclick="register()" 
            class="w-full bg-neon text-black py-3 rounded-lg font-semibold hover:bg-neon/90 transition"
          >
            Crear Cuenta
          </button>
          <div class="text-center">
            <button onclick="showLoginModal()" class="text-neon hover:underline">
              ¬øYa tienes cuenta? Inicia sesi√≥n
            </button>
          </div>
        </div>
      </div>

      <button 
        onclick="closeAuthModal()" 
        class="absolute top-4 right-4 text-gray-400 hover:text-white"
      >
        ‚úï
      </button>
    </div>
  </div>

  <!-- Simple Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-zinc-900 rounded-2xl p-8 w-full max-w-md border border-white/10">
        <h3 class="text-2xl font-bold mb-6 text-center">Iniciar Sesi√≥n</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Email</label>
            <input 
              type="email" 
              id="loginEmail" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="tu@email.com"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">Contrase√±a</label>
            <input 
              type="password" 
              id="loginPassword" 
              class="w-full px-4 py-2 bg-zinc-800 border border-white/20 rounded-lg focus:border-neon focus:outline-none"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>
          <button 
            onclick="performLogin()" 
            class="w-full bg-neon text-black py-3 rounded-lg font-semibold hover:bg-neon/90 transition"
          >
            Iniciar Sesi√≥n
          </button>
          <button 
            onclick="closeLoginModal()" 
            class="w-full border border-white/20 text-white py-3 rounded-lg font-semibold hover:bg-white/10 transition"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Button -->
  <div id="loginButton" class="fixed top-4 right-4 z-40">
    <button onclick="showLoginModal()" class="bg-neon text-black px-4 py-2 rounded-lg font-semibold hover:bg-neon/90 transition">
      Iniciar Sesi√≥n
    </button>
  </div>

  <!-- User Info -->
  <div id="userInfo" class="fixed top-4 right-4 z-40 hidden">
    <div class="bg-zinc-900 rounded-lg px-4 py-2 border border-white/10">
      <span id="userEmail" class="text-white text-sm"></span>
      <span id="userPlan" class="text-neon text-sm ml-2"></span>
      <button onclick="logout()" class="text-red-400 text-sm ml-2 hover:text-red-300">Salir</button>
    </div>
  </div>

  <!-- üéµ Son1k Commercial Integration Script -->
  <script src="commercial_integration.js"></script>
  
  <script>
    // Efecto Matrix
    function createMatrixEffect() {
      // Crear canvas para efecto Matrix
      const canvas = document.createElement('canvas');
      canvas.id = 'matrixCanvas';
      canvas.style.position = 'fixed';
      canvas.style.top = '0';
      canvas.style.left = '0';
      canvas.style.width = '100%';
      canvas.style.height = '100%';
      canvas.style.zIndex = '9999';
      canvas.style.pointerEvents = 'none';
      canvas.style.background = 'rgba(0, 0, 0, 0.1)';
      
      document.body.appendChild(canvas);
      
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const characters = '01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥';
      const matrix = characters.split('');
      
      const columns = canvas.width / 20;
      const drops = Array(Math.floor(columns)).fill(1);
      
      function drawMatrix() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#0f0';
        ctx.font = '20px monospace';
        
        for (let i = 0; i < drops.length; i++) {
          const text = matrix[Math.floor(Math.random() * matrix.length)];
          ctx.fillText(text, i * 20, drops[i] * 20);
          
          if (drops[i] * 20 > canvas.height && Math.random() > 0.975) {
            drops[i] = 0;
          }
          drops[i]++;
        }
      }
      
      const matrixInterval = setInterval(drawMatrix, 35);
      
      // Remover efecto despu√©s de 8 segundos
      setTimeout(() => {
        clearInterval(matrixInterval);
        if (canvas.parentNode) {
          canvas.parentNode.removeChild(canvas);
        }
      }, 8000);
    }

    // Easter egg: Terminal secreto (M√∫ltiples combinaciones)
    document.addEventListener('keydown', function(e) {
      // Debug - mostrar qu√© teclas se presionan
      console.log('Key pressed:', e.key, 'Ctrl:', e.ctrlKey, 'Alt:', e.altKey, 'Shift:', e.shiftKey);
      
      // M√∫ltiples combinaciones para activar terminal
      const isTerminalCombo = (
        (e.ctrlKey && e.altKey && e.key === 'h') ||           // Ctrl+Alt+H
        (e.ctrlKey && e.altKey && e.key === 'H') ||           // Ctrl+Alt+H (may√∫scula)
        (e.ctrlKey && e.shiftKey && e.key === 'T') ||         // Ctrl+Shift+T
        (e.ctrlKey && e.altKey && e.key === 't') ||           // Ctrl+Alt+T
        (e.key === 'F12' && e.ctrlKey) ||                    // Ctrl+F12
        (e.key === '`' && e.ctrlKey && e.altKey)              // Ctrl+Alt+`
      );
      
      if (isTerminalCombo) {
        e.preventDefault();
        console.log('üéµ Terminal activado!');
        
        // Activar efecto Matrix
        createMatrixEffect();
        
        // Mostrar terminal despu√©s de un peque√±o delay
        setTimeout(() => {
          const terminal = prompt('üéµ Son1kVers3 Terminal\n\nüåä MATRIX MODE ACTIVATED üåä\n\nComandos: help, status, easter, pixel, generate [prompt]\n\nIngresa comando:');
          if (terminal) {
            let result = '';
            const cmd = terminal.toLowerCase().trim();
            
            if (cmd === 'help') {
              result = 'üéµ Son1kVers3 Terminal v1.0\n\nüåä MATRIX EDITION üåä\n\nComandos disponibles:\n- help: Mostrar ayuda\n- status: Estado del sistema\n- easter: Activar easter eggs con Matrix\n- pixel: Info del asistente\n- generate [prompt]: Generar m√∫sica\n- matrix: Efecto Matrix permanente';
            } else if (cmd === 'status') {
              result = 'üéµ Son1kVers3 Status:\n\n‚úÖ API: Online\n‚úÖ Pixel: Activo\n‚úÖ Suno: Conectado\n‚úÖ Frontend: Funcional\nüåä Matrix: ACTIVATED\n\nüîã Sistema: 100% Operacional';
            } else if (cmd === 'easter') {
              result = 'ü•ö Easter eggs + Matrix activados!\n\nüåä Efecto Matrix lanzado\n‚ú® Efectos especiales habilitados\nüé® Tema visual cambiado\nüéµ Sonidos secretos activos\n\n"Welcome to the Matrix"';
              createMatrixEffect(); // Efecto Matrix adicional
              document.body.style.filter = 'hue-rotate(45deg)';
              setTimeout(() => document.body.style.filter = '', 10000);
            } else if (cmd === 'matrix') {
              result = 'üåä MATRIX EFFECT LAUNCHED üåä\n\nEfecto Matrix activado por 10 segundos\n\n"There is no spoon"';
              createMatrixEffect();
            } else if (cmd === 'pixel') {
              result = 'ü§ñ Pixel Assistant v1.0\n\nüéµ Especialidad: M√∫sica cyberpunk\nüß† Base de conocimiento: Activa\n‚ö° Tiempo de respuesta: <1s\nüéØ Precisi√≥n: 98.5%\nüåä Matrix Integration: ENABLED\n\n"Tu compa√±ero musical inteligente"';
            } else if (cmd.startsWith('generate ')) {
              const prompt = cmd.substring(9);
              result = `üéµ Generando m√∫sica...\n\nPrompt: "${prompt}"\n‚è≥ Procesando con Suno AI\nüì° Enviado a cola de generaci√≥n\nüåä Matrix boost aplicado\n\n¬°Revisa la secci√≥n Resultados!`;
              // Trigger real generation
              setTimeout(() => {
                fetch('/api/generate', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({prompt: prompt})
                }).catch(console.error);
              }, 1000);
            } else {
              result = `‚ùå Comando no reconocido: "${cmd}"\n\nEscribe "help" para ver comandos disponibles.\n\nüåä Matrix mode activo`;
            }
            
            alert(result);
          }
        }, 1000); // 1 segundo delay para que se vea el efecto Matrix
      }
    });

    // Agregar bot√≥n de terminal visible como respaldo
    function addTerminalButton() {
      const button = document.createElement('button');
      button.innerHTML = 'üñ•Ô∏è';
      button.title = 'Terminal Son1kVers3 (Ctrl+Alt+H, Ctrl+Shift+T, Ctrl+F12)';
      button.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #00ff00;
        background: rgba(0, 0, 0, 0.9);
        color: #00ff00;
        font-size: 20px;
        cursor: pointer;
        z-index: 9999;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
      `;
      
      button.onmouseover = () => {
        button.style.background = 'rgba(0, 255, 0, 0.2)';
        button.style.transform = 'scale(1.1)';
        button.style.boxShadow = '0 0 20px rgba(0, 255, 0, 0.6)';
      };
      
      button.onmouseout = () => {
        button.style.background = 'rgba(0, 0, 0, 0.9)';
        button.style.transform = 'scale(1)';
        button.style.boxShadow = '0 0 10px rgba(0, 255, 0, 0.3)';
      };
      
      button.onclick = () => {
        console.log('üéµ Terminal activado por bot√≥n!');
        createMatrixEffect();
        setTimeout(() => {
          const terminal = prompt('üéµ Son1kVers3 Terminal\n\nüåä MATRIX MODE ACTIVATED üåä\n\nComandos: help, status, easter, pixel, generate [prompt], matrix\n\nIngresa comando:');
          if (terminal) {
            let result = '';
            const cmd = terminal.toLowerCase().trim();
            
            if (cmd === 'help') {
              result = 'üéµ Son1kVers3 Terminal v1.0\n\nüåä MATRIX EDITION üåä\n\nComandos disponibles:\n- help: Mostrar ayuda\n- status: Estado del sistema\n- easter: Activar easter eggs con Matrix\n- pixel: Info del asistente Pixel\n- generate [prompt]: Generar m√∫sica\n- matrix: Efecto Matrix permanente\n\n‚å®Ô∏è Atajos de teclado:\n- Ctrl+Alt+H\n- Ctrl+Shift+T\n- Ctrl+F12\n- Bot√≥n üñ•Ô∏è';
            } else if (cmd === 'status') {
              result = 'üéµ Son1kVers3 Status:\n\n‚úÖ API: Online\n‚úÖ Pixel: Activo\n‚úÖ Suno: Conectado\n‚úÖ Frontend: Funcional\nüåä Matrix: ACTIVATED\nüíª Terminal: Operacional\n\nüîã Sistema: 100% Operacional';
            } else if (cmd === 'easter') {
              createMatrixEffect();
              result = 'üåä MATRIX EFFECT ACTIVATED! üåä\n\nEfecto Matrix ejecut√°ndose...\nLa resistencia digital ha comenzado.\n\n"No hay cuchara" - Neo\n\nüéµ La m√∫sica es nuestra realidad.';
            } else if (cmd === 'pixel') {
              result = 'ü§ñ Pixel - Asistente IA Musical\n\nEstado: ‚úÖ Activo\nVersi√≥n: 3.0 Matrix Edition\nCapacidades:\n- Generaci√≥n musical avanzada\n- Procesamiento de lenguaje natural\n- Creatividad musical ilimitada\n- Interfaz de terminal Matrix\n\n"La m√∫sica es el lenguaje universal" - Pixel';
            } else if (cmd.startsWith('generate ')) {
              const prompt = cmd.substring(9);
              result = `üéµ Generando m√∫sica...\n\nPrompt: "${prompt}"\n\n‚è≥ Conectando con Suno AI...\nüéº Creando melod√≠a √∫nica...\n‚ú® ¬°Tu m√∫sica estar√° lista pronto!\n\nUsa el bot√≥n "Generar" en el frontend para el proceso completo.`;
            } else if (cmd === 'matrix') {
              createMatrixEffect();
              result = 'üåä MATRIX RAIN EFFECT üåä\n\nLa Matrix ha sido activada...\nBienvenido a la realidad digital.\n\n‚å®Ô∏è Combinaciones de terminal:\n- Ctrl+Alt+H\n- Ctrl+Shift+T\n- Ctrl+F12\n- Ctrl+Alt+T\n- Ctrl+Alt+`\n- Bot√≥n üñ•Ô∏è (esquina superior derecha)';
            } else {
              result = `‚ùå Comando "${cmd}" no reconocido.\n\nUsa "help" para ver comandos disponibles.\n\nüåä Matrix mode activo`;
            }
            
            alert(result);
          }
        }, 1000);
      };
      
      document.body.appendChild(button);
    }
    
    // Agregar bot√≥n cuando cargue la p√°gina
    window.addEventListener('load', addTerminalButton);

    // Sistema de Login
    let currentUser = null;
    let userToken = null;

    function showLoginModal() {
      document.getElementById('loginModal').classList.remove('hidden');
    }

    function closeLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    }

    async function performLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        alert('Por favor ingresa email y contrase√±a');
        return;
      }

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (data.status === 'success') {
          currentUser = data.user;
          userToken = data.token;
          
          // Guardar en localStorage
          localStorage.setItem('user', JSON.stringify(currentUser));
          localStorage.setItem('token', userToken);
          
          // Actualizar UI
          updateUserUI();
          closeLoginModal();
          alert(`¬°Bienvenido ${email}! Plan: ${currentUser.plan.toUpperCase()}`);
        } else {
          alert('Error: ' + (data.detail || 'Credenciales incorrectas'));
        }
      } catch (error) {
        console.error('Error login:', error);
        alert('Error de conexi√≥n. Verifica que el servidor est√© activo.');
      }
    }

    function logout() {
      currentUser = null;
      userToken = null;
      localStorage.removeItem('user');
      localStorage.removeItem('token');
      updateUserUI();
      alert('Sesi√≥n cerrada');
    }

    function updateUserUI() {
      const loginButton = document.getElementById('loginButton');
      const userInfo = document.getElementById('userInfo');
      const userEmail = document.getElementById('userEmail');
      const userPlan = document.getElementById('userPlan');

      if (currentUser) {
        loginButton.classList.add('hidden');
        userInfo.classList.remove('hidden');
        userEmail.textContent = currentUser.email;
        userPlan.textContent = currentUser.plan.toUpperCase();
      } else {
        loginButton.classList.remove('hidden');
        userInfo.classList.add('hidden');
      }
    }

    // Restaurar sesi√≥n al cargar
    function restoreSession() {
      const savedUser = localStorage.getItem('user');
      const savedToken = localStorage.getItem('token');
      
      if (savedUser && savedToken) {
        currentUser = JSON.parse(savedUser);
        userToken = savedToken;
        updateUserUI();
      }
    }

    // Enter key en campos de login
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        if (document.getElementById('loginModal').classList.contains('hidden') === false) {
          performLogin();
        }
      }
    });

    // Modificar evento del bot√≥n para usar integraci√≥n Suno
    document.addEventListener('DOMContentLoaded', function() {
      // Restaurar sesi√≥n
      restoreSession();
      // Esperar a que el DOM est√© completamente cargado
      setTimeout(() => {
        // Remover evento anterior y agregar nuevo
        const btnGenerar = document.getElementById('generarMusica');
        if (btnGenerar) {
          // Clonar bot√≥n para remover eventos anteriores
          const newBtn = btnGenerar.cloneNode(true);
          btnGenerar.parentNode.replaceChild(newBtn, btnGenerar);
          
          // Agregar nuevo evento que use el sistema comercial
          newBtn.addEventListener('click', async function() {
            // Verificar disponibilidad del sistema comercial
            const sistemaDisponible = await checkCommercialSystemAvailability();
            if (!sistemaDisponible) {
              showToast('‚ö†Ô∏è Motor avanzado no disponible. Usando modo est√°ndar...', 'warning');
              // Fallback a funci√≥n original
              generarMusica();
              return;
            }
            
            // Usar motor comercial
            generateMusicCommercial();
          });
          
          // Mantener texto original del bot√≥n
          newBtn.innerHTML = 'üéµ Generar M√∫sica';
        }
        
        // Verificar estado del motor comercial al cargar
        checkCommercialSystemAvailability().then(disponible => {
          const statusIndicator = document.createElement('div');
          statusIndicator.className = 'fixed top-4 right-4 z-40 px-3 py-1 rounded-full text-xs font-medium';
          statusIndicator.innerHTML = disponible 
            ? 'üü¢ Sistema Listo' 
            : 'üî¥ Modo B√°sico';
          statusIndicator.style.backgroundColor = disponible ? '#10b981' : '#ef4444';
          statusIndicator.style.color = 'white';
          document.body.appendChild(statusIndicator);
          
          // Auto-hide despu√©s de 3 segundos
          setTimeout(() => statusIndicator.remove(), 3000);
        });
      }, 1000); // Esperar 1 segundo para asegurar que todo est√© cargado
    });
  </script>

</body>
</html>